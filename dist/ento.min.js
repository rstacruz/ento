(function(t,e){if(typeof define==="function"&&define.amd){define(["underscore"],e)}else if(typeof exports==="object"){module.exports=e(n())}else{t.Ento=e(n())}function n(){try{return require("underscore")}catch(e){return t._}}})(this,function(t){if(!t)throw new Error("Ento: underscore.js not found.");var e;function n(){return e.extend()}var r=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t,e){if(t===null||typeof t==="undefined")return t;if(e===String)return""+t;if(e===Number)return+t;if(e===Date)return new Date(t);if(e===Boolean){if(typeof t==="string"){t=t.toLowerCase();if(t==="1"||t==="yes"||t==="true")return true;else if(t==="0"||t==="no"||t==="false"||t==="")return false}else if(typeof t==="number"){return t!==0}else{return!!t}}}})();return t.exports}();var i=function(){var t={exports:{}},e=t.exports;(function(){e.camelize=function(t){return t.trim().replace(/[-_\s]+(.)?/g,function(t,e){return e.toUpperCase()})};e.underscored=function(t){return t.trim().replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[\.-\s]+/g,"_").toLowerCase()}})();return t.exports}();var s=i.camelize;var o=i.underscored;n.events=function(){var t={exports:{}},e=t.exports;(function(){var e=[].slice;t.exports=function(t){var n={on:function(t,e,n){if(!i(this,"on",t,[e,n])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);r.push({callback:e,context:n,ctx:n});return this},once:function(e,n,r){if(!i(this,"once",e,[n,r])||!n)return this;var s=this;var o=t.once(function(){s.off(e,o);n.apply(this,arguments)});o._callback=n;return this.on(e,o,r)},off:function(e,n,r){var s,o,u,f,a,c,h,l;if(!this._events||!i(this,"off",e,[n,r]))return this;if(!e&&!n&&!r){this._events=void 0;return this}f=e?[e]:t.keys(this._events);for(a=0,c=f.length;a<c;a++){e=f[a];if(u=this._events[e]){this._events[e]=s=[];if(n||r){for(h=0,l=u.length;h<l;h++){o=u[h];if(n&&n!==o.callback&&n!==o.callback._callback||r&&r!==o.context){s.push(o)}}}if(!s.length)delete this._events[e]}}return this},trigger:function(t){var n=e.call(arguments,1);return this.triggerFor(this,t,n)},triggerFor:function(t,e,n){if(!this._events)return this;if(!i(this,"trigger",e,n))return this;var r=this._events[e];var o=this._events.all;if(r)s(r,t,n);if(o)s(o,t,arguments);return this},stopListening:function(e,n,r){var i=this._listeningTo;if(!i)return this;var s=!n&&!r;if(!r&&typeof n==="object")r=this;if(e)(i={})[e._listenId]=e;for(var o in i){e=i[o];e.off(n,r,this);if(s||t.isEmpty(e._events))delete this._listeningTo[o]}return this}};var r=/\s+/;var i=function(t,e,n,i){if(!n)return true;if(typeof n==="object"){for(var s in n){t[e].apply(t,[s,n[s]].concat(i))}return false}if(r.test(n)){var o=n.split(r);for(var u=0,f=o.length;u<f;u++){t[e].apply(t,[o[u]].concat(i))}return false}return true};var s=function(t,e,n){var r,i=-1,s=t.length,o=n[0],u=n[1],f=n[2];switch(n.length){case 0:while(++i<s)(r=t[i]).callback.call(r.ctx||e);return;case 1:while(++i<s)(r=t[i]).callback.call(r.ctx||e,o);return;case 2:while(++i<s)(r=t[i]).callback.call(r.ctx||e,o,u);return;case 3:while(++i<s)(r=t[i]).callback.call(r.ctx||e,o,u,f);return;default:while(++i<s)(r=t[i]).callback.apply(r.ctx||e,n);return}};var o={listenTo:"on",listenToOnce:"once"};t.each(o,function(e,r){n[r]=function(n,r,i){var s=this._listeningTo||(this._listeningTo={});var o=n._listenId||(n._listenId=t.uniqueId("l"));s[o]=n;if(!i&&typeof r==="object")i=this;n[e](r,i,this);return this}});return n}})();return t.exports}()(t);n.persistence=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return function(e){e.on("init",function(){this.is.loading=false}).use({fetch:function(t){if(!this.api||!this.api.sync)throw new Error("fetch(): no api.sync");var e=this.api.sync;var r=this;n(r,{fetching:true,error:false});r.trigger("fetching");e("get",r,function(e,i){if(e){n(r,{fetching:false,error:e});r.trigger("error");if(t)t(e)}else{n(r,{fetching:false,loaded:true,error:false});r.set(i);r.trigger("load");if(t)t(e,i)}})},save:function(){},destroy:function(){}});function n(e,n){t.extend(e.is,n);e.trigger("change:is",e.is)}}}})();return t.exports}()(t);n.collection=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return function(){}}})();return t.exports}()(t);n.exportable=function(){var t={exports:{}},e=t.exports;(function(){t.exports={"export":function(){var t={};var e=this.constructor.attributes;for(var n in e){if(e.hasOwnProperty(n)){var r=e[n];if(r.enumerable!==false&&r.export!==false){t[n]=this[n]}}}t.is=this.is;return t}}})();return t.exports}();n.relations=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t,e){return function(t){t.hasOne=function(t,e,r){n(t,e,r,true);return this};t.belongsTo=function(t,e,i){n(t,e,i,false);r(t,e,i);return this};function n(n,r,i,s){n=e(n);t.attr(n,{set:function(t){var e,o=this;if(s)this.stopListening(e,"change");if(!t){this.raw[n]=undefined;return}if(typeof t!=="object")throw new Error("not an object");if(t.constructor===Object)e=new(i())(t);else if(t instanceof i())e=t;else throw new Error("invalid type");this.raw[n]=e;if(s){this.listenTo(e,"change",function(){o.trigger("change:"+n,o.get(n));o.trigger("change")})}if(r.as&&e[r.as]!==this)e[r.as]=this;return},json:s})}function r(n,r,i){n=e(n);var s=n+"Id";t.attr(s,{set:function(t){var e=this.get(n);if(!e||!e.id||e.id!==t)this.setOne(n,{id:t})},get:function(){var t=this.get(n);if(t)return t.id},json:true})}}}})();return t.exports}()(t,s);n.object=e=function(t){if(t!==false)return this.constructor.build.apply(this,arguments)};e.extended=function(){this.attributes={}};e.extended();t.extend(e,n.events);e.attr=function(e){var n=u.apply(this,arguments);this.attributes[e]=n;var r=t.uniq([e,s(e),o(e)]);var i=function(t){this.setOne(e,t)};for(var f=0,a=r.length;f<a;f++){if(this.prototype[r[f]])continue;Object.defineProperty(this.prototype,r[f],{enumerable:n.enumerable,get:n.get,set:i})}return this};function u(e){var n={};e=s(e);n.name=e;for(var i=1,o=arguments.length;i<o;i++){var u=arguments[i];if(typeof u==="object"){t.extend(n,u)}else if(~[Number,String,Date,Boolean].indexOf(u)){n.type=u}else if(typeof u==="function"){if(!n.get)n.get=u;else if(!n.set)n.set=u}}if(typeof n.enumerable==="undefined")n.enumerable=true;if(!n.get&&n.type)n.get=function(){return r(this.raw[e],n.type)};if(!n.get)n.get=function(){return this.raw[e]};if(!n.set)n.set=function(t){this.raw[e]=t};return n}e.attributeNames=function(){return t.keys(this.attributes)};e.use=function(e,n){if(!e&&arguments.length===1){throw new Error("ento.use: invalid arguments")}else if(typeof e==="function"){e.call(this,this)}else if(typeof e==="object"){t.extend(this.prototype,e)}if(typeof n==="object"){t.extend(this,n)}return this};e.extend=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return function(e,n){var r=this;var i;if(e&&t.has(e,"constructor")){i=e.constructor}else{i=function(){return r.apply(this,arguments)}}t.extend(i,r,n);var s=function(){this.constructor=i};s.prototype=r.prototype;i.prototype=new s;if(e)t.extend(i.prototype,e);i.__super__=r.prototype;if(typeof i.extended==="function")i.extended();return i}}})();return t.exports}()(t);e.use(n.events);e.api=function(t){if(!arguments.length)return this.prototype.api;this.prototype.api=t;return this};e.build=function(){var t,n,r;if(this instanceof e)r=this;else r=new this(false);if(arguments.length===2){t=arguments[0];n=arguments[1]}else{t=r.constructor.api();n=arguments[0]}Object.defineProperty(r,"raw",{value:{},enumerable:false});Object.defineProperty(r,"is",{value:{},enumerable:false});if(t)r.api=t;r.trigger("build",r);if(n)r.set(n);r.is.fresh=true;r.trigger("init",r);r.init(n);return r};e.use({init:function(t){},set:function(t,e,n){if(typeof t==="object")return this.setMany(t,e);else return this.setOne(t,e,n)},setMany:function(t,e){if(!e)e={};e.nochange=true;for(var n in t)if(t.hasOwnProperty(n))this.setOne(n,t[n],e);if(!e||!e.silent)this.trigger("change",t)},setOne:function(e,n,r){var i=this;this.is.fresh=false;var u=this.constructor.attributes[e];if(u&&u.set)u.set.call(this,n);else this[e]=n;if(!r||!r.silent){var f=t.uniq([e,s(e),o(e)]);t.each(f,function(t){i.trigger("change:"+t,n)});if(!r||!r.nochange){var a={};a[e]=n;this.trigger("change",a)}}},get:function(t){var e=this.constructor.attributes[t];if(e)return e.get.apply(this);else return this[t]},trigger:function(t){n.events.trigger.apply(this,arguments);n.events.triggerFor.call(this.constructor,this,t,[].slice.call(arguments,1));return this},toJSON:function(){var e={};var n=this;t.each(this,function(t,n){e[n]=t});var r=this.constructor.attributes;t.each(r,function(t,r){if(t.json===false)return;e[r]=n[r]});return e}});return n});