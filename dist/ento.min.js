(function(t,e){if(typeof define==="function"&&define.amd){define(["underscore"],e)}else if(typeof exports==="object"){module.exports=e(r())}else{t.Ento=e(r())}function r(){try{return require("underscore")}catch(e){return t._}}})(this,function(t){if(!t)throw new Error("Ento: underscore.js not found.");var e;function r(){return e.extend()}var n=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t,e){if(t===null||typeof t==="undefined")return t;if(e===String)return""+t;if(e===Number)return+t;if(e===Date)return new Date(t);if(e===Boolean){if(typeof t==="string"){t=t.toLowerCase();if(t==="1"||t==="yes"||t==="true")return true;else if(t==="0"||t==="no"||t==="false"||t==="")return false}else if(typeof t==="number"){return t!==0}else{return!!t}}}})();return t.exports}();var i=function(){var t={exports:{}},e=t.exports;(function(){e.camelize=function(t){return t.trim().replace(/[-_\s]+(.)?/g,function(t,e){return e.toUpperCase()})};e.underscored=function(t){return t.trim().replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[\.-\s]+/g,"_").toLowerCase()}})();return t.exports}();var s=i.camelize;var o=i.underscored;r.events=function(){var t={exports:{}},e=t.exports;(function(){var e=[].slice;t.exports=function(t){var r={on:function(t,e,r){if(!i(this,"on",t,[e,r])||!e)return this;this._events||(this._events={});var n=this._events[t]||(this._events[t]=[]);n.push({callback:e,context:r,ctx:r});return this},once:function(e,r,n){if(!i(this,"once",e,[r,n])||!r)return this;var s=this;var o=t.once(function(){s.off(e,o);r.apply(this,arguments)});o._callback=r;return this.on(e,o,n)},off:function(e,r,n){var s,o,u,f,a,c,h,l;if(!this._events||!i(this,"off",e,[r,n]))return this;if(!e&&!r&&!n){this._events=void 0;return this}f=e?[e]:t.keys(this._events);for(a=0,c=f.length;a<c;a++){e=f[a];if(u=this._events[e]){this._events[e]=s=[];if(r||n){for(h=0,l=u.length;h<l;h++){o=u[h];if(r&&r!==o.callback&&r!==o.callback._callback||n&&n!==o.context){s.push(o)}}}if(!s.length)delete this._events[e]}}return this},trigger:function(t){var r=e.call(arguments,1);return this.triggerFor(this,t,r)},triggerFor:function(t,e,r){if(!this._events)return this;if(!i(this,"trigger",e,r))return this;var n=this._events[e];var o=this._events.all;if(n)s(n,t,r);if(o)s(o,t,arguments);return this},stopListening:function(e,r,n){var i=this._listeningTo;if(!i)return this;var s=!r&&!n;if(!n&&typeof r==="object")n=this;if(e)(i={})[e._listenId]=e;for(var o in i){e=i[o];e.off(r,n,this);if(s||t.isEmpty(e._events))delete this._listeningTo[o]}return this}};var n=/\s+/;var i=function(t,e,r,i){if(!r)return true;if(typeof r==="object"){for(var s in r){t[e].apply(t,[s,r[s]].concat(i))}return false}if(n.test(r)){var o=r.split(n);for(var u=0,f=o.length;u<f;u++){t[e].apply(t,[o[u]].concat(i))}return false}return true};var s=function(t,e,r){var n,i=-1,s=t.length,o=r[0],u=r[1],f=r[2];switch(r.length){case 0:while(++i<s)(n=t[i]).callback.call(n.ctx||e);return;case 1:while(++i<s)(n=t[i]).callback.call(n.ctx||e,o);return;case 2:while(++i<s)(n=t[i]).callback.call(n.ctx||e,o,u);return;case 3:while(++i<s)(n=t[i]).callback.call(n.ctx||e,o,u,f);return;default:while(++i<s)(n=t[i]).callback.apply(n.ctx||e,r);return}};var o={listenTo:"on",listenToOnce:"once"};t.each(o,function(e,n){r[n]=function(r,n,i){var s=this._listeningTo||(this._listeningTo={});var o=r._listenId||(r._listenId=t.uniqueId("l"));s[o]=r;if(!i&&typeof n==="object")i=this;r[e](n,i,this);return this}});return r}})();return t.exports}()(t);r.persistence=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return function(e){e.on("init",function(){this.is.loading=false}).use({fetch:function(t){if(!this.api||!this.api.sync)throw new Error("fetch(): no api.sync");var e=this.api.sync;var n=this;r(n,{fetching:true,error:false});n.trigger("fetching");e("get",n,function(e,i){if(e){r(n,{fetching:false,error:e});n.trigger("error");if(t)t(e)}else{r(n,{fetching:false,loaded:true,error:false});n.set(i);n.trigger("load");if(t)t(e,i)}})},save:function(){},destroy:function(){}});function r(e,r){t.extend(e.is,r);e.trigger("change:is",e.is)}}}})();return t.exports}()(t);r.collection=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return function(){}}})();return t.exports}()(t);r.exportable=function(){var t={exports:{}},e=t.exports;(function(){t.exports={"export":function(){var t={};var e=this.constructor.attributes;for(var r in e){if(e.hasOwnProperty(r)){var n=e[r];if(n.enumerable!==false&&n.export!==false){t[r]=this[r]}}}t.is=this.is;return t}}})();return t.exports}();r.relations=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t,e){return function(t){t.hasOne=function(t,e,n){r(t,e,n,true);return this};t.belongsTo=function(t,e,i){r(t,e,i,false);n(t,e,i);return this};function r(r,n,i,s){r=e(r);t.attr(r,{set:function(t){var e,o=this;if(s)this.stopListening(e,"change");if(!t){this.raw[r]=undefined;return}if(typeof t!=="object")throw new Error("not an object");if(t.constructor===Object)e=new(i())(t);else if(t instanceof i())e=t;else throw new Error("invalid type");this.raw[r]=e;if(s){this.listenTo(e,"change",function(){o.trigger("change:"+r,o.get(r));o.trigger("change")})}if(n.as&&e[n.as]!==this)e[n.as]=this;return},json:s})}function n(r,n,i){r=e(r);var s=r+"Id";t.attr(s,{set:function(t){var e=this.get(r);if(!e||!e.id||e.id!==t)this.setOne(r,{id:t})},get:function(){var t=this.get(r);if(t)return t.id},json:true})}}}})();return t.exports}()(t,s);r.ractiveAdaptor=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return{filter:function(t,e,r){return t&&t.on&&t.off&&t.set&&t.get},wrap:function(t,e,r,n){var i;e.on("change",function(s){if(s){i=true;t.set(n(e.get(s)))}else{t.update(r)}},t);return{get:function(){return e.get()},teardown:function(){e.off(null,null,t)},set:function(t,r){if(i){i=false;return}e.set(t,r)},reset:function(t){return false}}}}}})();return t.exports}()(t);var u=function(){var t={exports:{}},e=t.exports;(function(){var e=t.exports=function(){this.ltr={};this.rtl={}};e.prototype={add:function(t,e){var n=this.ltr,i=this.rtl;if(!n[t])n[t]={};r(e,function(e){if(!i[e])i[e]={};n[t][e]=true;i[e][t]=true})},dependencies:function(t){return this.traverse(this.ltr,t)},dependents:function(t){return this.traverse(this.rtl,t)},traverse:function(t,e){if(typeof e==="string")e=[e];var n={},i=this;r(e,function(e){n[e]=true;i.traverseKeys(n,t,e)});return Object.keys(n)},traverseKeys:function(t,e,n){var i=this;r(e[n],function(r,n){t[n]=i.traverseKeys(t,e,n)});return t}};function r(t,e){if(t)for(var r in t)if(t.hasOwnProperty(r))e(t[r],r)}})();return t.exports}();r.object=e=function(t){if(t!==false)return this.constructor.build.apply(this,arguments)};e.extended=function(){this.attributes={};this.deps=new u};e.extended();t.extend(e,r.events);e.attr=function(e){var r=f.apply(this,arguments);e=s(e);this.attributes[e]=r;if(r.via)this.deps.add(e,r.via);var n=t.uniq([e,o(e)]);var i=function(t){this.setOne(e,t)};for(var u=0,a=n.length;u<a;u++){if(this.prototype[n[u]])continue;Object.defineProperty(this.prototype,n[u],{enumerable:r.enumerable,get:r.get,set:i})}return this};function f(e){var r={};r.name=e;for(var i=1,o=arguments.length;i<o;i++){var u=arguments[i];if(Array.isArray(u)){r.via=u}else if(typeof u==="object"){t.extend(r,u)}else if(~[Number,String,Date,Boolean].indexOf(u)){r.type=u}else if(typeof u==="function"){if(!r.get)r.get=u;else if(!r.set)r.set=u}}if(typeof r.enumerable==="undefined")r.enumerable=true;if(!r.get&&r.type)r.get=function(){return n(this.raw[e],r.type)};if(!r.get)r.get=function(){return this.raw[e]};if(!r.set)r.set=function(t){this.raw[e]=t};if(typeof r.via==="string")r.via=[r.via];if(r.via)r.via=r.via.map(s);return r}e.attributeNames=function(){return t.keys(this.attributes)};e.use=function(e,r){if(!e&&arguments.length===1){throw new Error("ento.use: invalid arguments")}else if(typeof e==="function"){e.call(this,this)}else if(typeof e==="object"){t.extend(this.prototype,e)}if(typeof r==="object"){t.extend(this,r)}return this};e.extend=function(){var t={exports:{}},e=t.exports;(function(){t.exports=function(t){return function(e,r){var n=this;var i;if(e&&t.has(e,"constructor")){i=e.constructor}else{i=function(){return n.apply(this,arguments)}}t.extend(i,n,r);var s=function(){this.constructor=i};s.prototype=n.prototype;i.prototype=new s;if(e)t.extend(i.prototype,e);i.__super__=n.prototype;if(typeof i.extended==="function")i.extended();return i}}})();return t.exports}()(t);e.use(r.events);e.use(r.exportable);e.api=function(t){if(!arguments.length)return this.prototype.api;this.prototype.api=t;return this};e.build=function(){var t,r,n;if(this instanceof e)n=this;else n=new this(false);if(arguments.length===2){t=arguments[0];r=arguments[1]}else{t=n.constructor.api();r=arguments[0]}Object.defineProperty(n,"raw",{value:{},enumerable:false});Object.defineProperty(n,"is",{value:{},enumerable:false});if(t)n.api=t;n.trigger("build",n);if(r)n.set(r);n.is.fresh=true;n.trigger("init",n);n.init(r);return n};e.use({init:function(t){},set:function(t,e,r){if(typeof t==="object")return this.setMany(t,e);else return this.setOne(t,e,r)},setMany:function(t,e){if(!e)e={};e.nochange=true;for(var r in t)if(t.hasOwnProperty(r))this.setOne(r,t[r],{silent:true});if(!e||!e.silent)this.triggerChange(t)},setOne:function(t,e,r){var n=this;this.is.fresh=false;var i=this.constructor.attributes[t];if(i&&i.set)i.set.call(this,e);else this[t]=e;if(!r||!r.silent){var s={};s[t]=e;this.triggerChange(s)}},triggerChange:function(e){var r=this;var n=this.constructor.deps.dependents(t.keys(e));t.each(n,function(e){var n=t.uniq([e,o(e)]);t.each(n,function(t){r.trigger("change:"+t,t)})});r.trigger("change",n)},get:function(e){if(arguments.length===0)return this.export();if(Array.isArray(e))return this.getMany(e);else if(typeof e==="object")return this.getMany(t.keys(e));else return this.getOne(e)},getMany:function(e){var r={};var n=this;t.each(e,function(t){r[t]=n.get(t)});return r},getOne:function(t){var e=this.constructor.attributes[t];if(e)return e.get.apply(this);else return this[t]},trigger:function(t){r.events.trigger.apply(this,arguments);r.events.triggerFor.call(this.constructor,this,t,[].slice.call(arguments,1));return this},toJSON:function(){var e={};var r=this;t.each(this,function(t,r){e[r]=t});var n=this.constructor.attributes;t.each(n,function(t,n){if(t.json===false)return;e[n]=r[n]});return e}});return r});